sudo: required

language: node_js

node_js:
- 12.13

branches:
  only:
    - master
    - develop

services:
  - docker

cache: yarn

env:
  global:
  - FE_IMAGE_TAG=0.0.1
  - BE_IMAGE_TAG=0.0.1

  - FE_IMAGE_NAME=bu-front
  - BE_IMAGE_NAME=bu-back
  - DOCKER_USER=jdd04026
  - secure: B2A5EkMfMm88KX+y/nXKaVz9+TfrLCY7Fw6jbkrmPzQ3N7IIMBDOE5g0YNCA+kpJTTJmMCVIKji28c5C8x0dlCPb9htDzZ4nLoQi5QtxtAigyTORrXjy/wkVuNa0GuLUMV5VAZOn2vjqMFfX94lwSAnGAs9+S0u5ZRvYPH2X0NddajgJGVYW0g9mN6V+IepOT/nO9ecxCwSLS9Cak8b/tCRlpOAoUlbeb8t8uvPFiIwqPWmAs3PjRJHDIGzTzek/6S5X+jGXqxGUhRJemzGxM4egy+Zw/UZIoReiU3M89cvjDZS5CPh4H3U/asQu3+Or2fDbk9xdppmS4C/MmHHF/jj7zqzH51byxLbQdqJgSUJCLX8+I6dhjkXLlG2BhpM6g6DQgrYVTDK6TziLGetHW/dXG8+ZunR+HmtIcp9Qt0Bu+zAwkvYXXPAYqeRv/+5XPkUdQXYdkSC/zliASdotIagznhn9xs7f3qdnPCfN4iR5oUMm8WdJ/0wnIfvxgKnSU6Nm0FdtQHFe0QvzN9CuWl+yHT2oOQlRc5IHYDFO2yOpV9/6uoOaB9kPXgeDaElWL2rNwvvYSXBR/T4/ejaSy6JWkuiwEHWSNeoL8IvrPfGOCGoRf2xIA/heFCzNuT6/o+wAYTRDmHYhmM3P624hevf7YJD6Ta/trhpe6JfugNQ=
  - CLIENT_URL=http://localhost:3000
  - API_URL=http://localhost:13000
  - CLIENT_ID=89261830012-cobrenh5fepq64nhj54jcdthoit1tjom.apps.googleusercontent.com
  - secure: Zb2HiLM/eq+bFlU1iV5djvVC9cN56tXjprEPDnWU2n1b0jaBJ3502kJpHLGtupCeVqnqzWrs16qsX85S8n/V6M3EqUGMDnKG7BV3VQfxheIu0BNGo30cjxBUTwuZNP+e5aybyEDrvpDOjzrs7kPMkNZfXraCgVV/IfOkjZKXps5mO5dZacxNWEfQZB9UfTW/YSGJ8i3QZ5sM4v29QCulUs9VPAAY0fypvBs3FKemWZincD4QVGqtXAK2Cex1Lpfc1Q8gvQA0g/HZRlBnbt73Z6qyVHGkzxEciMS2vOtfONbdKf4o1NZLjhSoSg11JaFNbXDitMhLycqCXgCcdS8GEwqoh5EtkJm7zNgf25KgiCdV+jqhEQnBRSurnLR1m+j9m0In2LjIzRV4z/DxvjBtBj304QUVRuNFiVmZJ9ZNf2RobX5u4ntA1lHD40aHpCCR2Z4yiFgUZtGEamzjdBq6xaPHaLApytxLPvgK/tKIuF+fi45PvdaXNRVrWdP53S+rtW1tDx7zVJ8m0MRb0t1uabMXWUYM+zI3izrH9it+aIG8i1lFkiCK00IU9M5XnMYCwRqmS+jbBYu8VUht6cO2AtM12Xh2gl0TkORG/FI3yjWmMskeDXof+0LtJoRYOjBhAa2kTKMqmmuUwZKFh66thkShOLCZXS7ohPtk2yEUN1k=
  - DB_HOST=127.0.0.1
  - DB_USER=user
  - DB_NAME=bookus
  - secure: C9PIv3PAVNasIpkZ7xXqiMjQGozvE0t+2qNo63Xwwr52fgJehtyNpOLw3uYbdDQ0OtwLGEx42TYkyuZKklWsc9KDpDfafzghueoHmdYkcIOsjxajxKn4F89VLbNQJw6jZxXqRRoYyqGMl6BBAK72dGrdq8h3zuV9Kx0nJD4pO3w/J3zsuVqrSVw2vPz7jcwCp+M6cL1HeNJfvPKmy0ss8choX6dZi5aESm2gTB3Al4O8tCNJfBws3N4xxVYN0C81lzKnnOgGqIDPr/Mg9X5Bt3BQr95YL8CGNX20jKsRCWa003fWU0TzK57NSVmYQUlXDoy9JU8YyT4Zqkfh34I45HamTl4rCuzerQFwSjxLbP5QVmOY+ulH/8lzn+8q2B+ANVB8DEHdyUyAsBKlLVuEqdYNWEA5rQ7sMNKDdGlCr8RLHxUbjZV+tK1li3vA8NA983gAJmuMYR8q4InjBODsaJYJy3AoeAP+HuWWz6yHlTReQWnFLHXUGVHDsISnPe+eK1p/8hhIBJGKufBqF4J5Dgh10xchPFREZRdVZNiIpceRskGV5rjjhs6ZfaIb4pVwvF1e3oJGersuaeo2bqCyDGj/ICsjY9Gh42/qgHe/fY+i3Suc7nsz4BWFEStZKiho5gBeSkdI+qhzmdSL8v410xBmHMNY3Om0jkYHJdb+B1A=

jobs:
  include:
  - stage: TEST
    name: Server
    install:
      - docker run --name mysql -d
        -e MYSQL_ROOT_PASSWORD=$DB_PW 
        -e MYSQL_DATABASE=$DB_NAME 
        -e MYSQL_USER=$DB_USER 
        -e MYSQL_PASSWORD=$DB_PW 
        -p 3306:3306 
        jdd04026/mariadb-locale:latest
    before_script:
      - yarn
    script:
      - yarn workspace server db:migrate
      - yarn workspace server db:seed
      - yarn test:server

    name: Client
    before_script:
      - yarn
    script:
      - yarn test:client

  - stage: DEPLOY
    name: Server
    if: type = push AND branch = master
    before_install:
      - echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin;
    script:
      - docker build -t "${DOCKER_USER}/${BE_IMAGE_NAME}:${BE_IMAGE_TAG}" ./server
      - docker tag "${DOCKER_USER}/${BE_IMAGE_NAME}:${BE_IMAGE_TAG}" "${DOCKER_USER}/${BE_IMAGE_NAME}:latest"
      - docker push "${DOCKER_USER}/${BE_IMAGE_NAME}:latest" && docker push "${DOCKER_USER}/${BE_IMAGE_NAME}:${BE_IMAGE_TAG}"

    name: Client
    if: type = push AND branch = master
    before_install:
      - echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin;
    script:
      - docker build -t "${DOCKER_USER}/${FE_IMAGE_NAME}:${FE_IMAGE_TAG}" ./client
      - docker tag "${DOCKER_USER}/${FE_IMAGE_NAME}:${FE_IMAGE_TAG}" "${DOCKER_USER}/${FE_IMAGE_NAME}:latest"
      - docker push "${DOCKER_USER}/${FE_IMAGE_NAME}:latest" && docker push "${DOCKER_USER}/${FE_IMAGE_NAME}:${FE_IMAGE_TAG}"